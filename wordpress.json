{"AWSTemplateFormatVersion":"2010-09-09","Description":"AWS CloudFormation Sample Template WordPress_Single_Instance: WordPress is web software you can use to create a beautiful website or blog. This template installs WordPress with a local MySQL database for storage. It demonstrates using the AWS CloudFormation bootstrap scripts to deploy WordPress. **WARNING** This template creates an Amazon EC2 instance. You will be billed for the AWS resources used if you create a stack from this template.","Mappings":{"AWSInstanceType2Arch":{"t1.micro":{"Arch":"HVM64"},"t2.medium":{"Arch":"HVM64"},"t2.micro":{"Arch":"HVM64"},"t2.nano":{"Arch":"HVM64"},"t2.small":{"Arch":"HVM64"}},"AWSInstanceType2NATArch":{"t1.micro":{"Arch":"NATHVM64"},"t2.medium":{"Arch":"NATHVM64"},"t2.micro":{"Arch":"NATHVM64"},"t2.nano":{"Arch":"NATHVM64"},"t2.small":{"Arch":"NATHVM64"}},"AWSRegionArch2AMI":{"ap-southeast-1":{"HVM64":"ami-08569b978cc4dfa10","HVMG2":"ami-0be9df32ae9f92309"},"ap-southeast-2":{"HVM64":"ami-09b42976632b27e9b","HVMG2":"ami-0a9ce9fecc3d1daf8"}}},"Outputs":{"WebsiteURL":{"Description":"WordPress Website","Value":{"Fn::Join":["",["http://",{"Fn::GetAtt":["WebServer","PublicDnsName"]},"/wordpress"]]}}},"Parameters":{"DBName":{"AllowedPattern":"[a-zA-Z][a-zA-Z0-9]*","ConstraintDescription":"must begin with a letter and contain only alphanumeric characters.","Default":"wordpressdb","Description":"The WordPress database name","MaxLength":"64","MinLength":"1","Type":"String"},"DBPassword":{"AllowedPattern":"[a-zA-Z0-9]*","ConstraintDescription":"must contain only alphanumeric characters.","Description":"The WordPress database admin account password","MaxLength":"41","MinLength":"8","NoEcho":"true","Type":"String"},"DBRootPassword":{"AllowedPattern":"[a-zA-Z0-9]*","ConstraintDescription":"must contain only alphanumeric characters.","Description":"MySQL root password","MaxLength":"41","MinLength":"8","NoEcho":"true","Type":"String"},"DBUser":{"AllowedPattern":"[a-zA-Z][a-zA-Z0-9]*","ConstraintDescription":"must begin with a letter and contain only alphanumeric characters.","Description":"The WordPress database admin account username","MaxLength":"16","MinLength":"1","NoEcho":"true","Type":"String"},"InstanceType":{"AllowedValues":["t1.micro","t2.nano","t2.micro","t2.small","t2.medium"],"ConstraintDescription":"must be a valid EC2 instance type.","Default":"t2.small","Description":"WebServer EC2 instance type","Type":"String"},"KeyName":{"ConstraintDescription":"must be the name of an existing EC2 KeyPair.","Description":"Name of an existing EC2 KeyPair to enable SSH access to the instances","Type":"AWS::EC2::KeyPair::KeyName"},"SSHLocation":{"AllowedPattern":"(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})","ConstraintDescription":"must be a valid IP CIDR range of the form x.x.x.x/x.","Default":"0.0.0.0/0","Description":"The IP address range that can be used to SSH to the EC2 instances","MaxLength":"18","MinLength":"9","Type":"String"}},"Resources":{"WebServer":{"CreationPolicy":{"ResourceSignal":{"Timeout":"PT15M"}},"Metadata":{"AWS::CloudFormation::Init":{"configSets":{"wordpress_install":["install_cfn","install_wordpress","configure_wordpress"]},"configure_wordpress":{"commands":{"01_set_mysql_root_password":{"command":{"Fn::Join":["",["mysqladmin -u root password '",{"Ref":"DBRootPassword"},"'"]]},"test":{"Fn::Join":["",["$(mysql ",{"Ref":"DBName"}," -u root --password='",{"Ref":"DBRootPassword"},"' \u003e/dev/null 2\u003e\u00261 \u003c/dev/null); (( $? != 0 ))"]]}},"02_create_database":{"command":{"Fn::Join":["",["mysql -u root --password='",{"Ref":"DBRootPassword"},"' \u003c /tmp/setup.mysql"]]},"test":{"Fn::Join":["",["$(mysql ",{"Ref":"DBName"}," -u root --password='",{"Ref":"DBRootPassword"},"' \u003e/dev/null 2\u003e\u00261 \u003c/dev/null); (( $? != 0 ))"]]}},"03_configure_wordpress":{"command":"/tmp/create-wp-config","cwd":"/var/www/html/wordpress"}}},"install_cfn":{"files":{"/etc/cfn/cfn-hup.conf":{"content":{"Fn::Join":["",["[main]\n","stack=",{"Ref":"AWS::StackId"},"\n","region=",{"Ref":"AWS::Region"},"\n"]]},"group":"root","mode":"000400","owner":"root"},"/etc/cfn/hooks.d/cfn-auto-reloader.conf":{"content":{"Fn::Join":["",["[cfn-auto-reloader-hook]\n","triggers=post.update","path=Resources.WebServer.Metadata.AWS::CloudFormation::Init","action=/opt/aws/bin/cfn-init -v ","         --stack ",{"Ref":"AWS::StackName"},"         --resource WebServer ","         --configsets wordpress_install ","         --region ",{"Ref":"AWS::Region"},"\n"]]},"group":"root","mode":"000400","owner":"root"}},"services":{"sysvinit":{"cfn-hup":{"enabled":"true","ensureRunning":"true","files":["/etc/cfn/cfn-hup.conf","/etc/cfn/hooks.d/cfn-auto-reloader.conf"]}}}},"install_wordpress":{"files":{"/tmp/create-wp-config":{"content":{"Fn::Join":["",["#!/bin/bash -xe\n","cp /var/www/html/wordpress/wp-config-sample.php /var/www/html/wordpress/wp-config.php","sed -i \"s/'database_name_here'/'",{"Ref":"DBName"},"'/g\" wp-config.php","sed -i \"s/'username_here'/'",{"Ref":"DBUser"},"'/g\" wp-config.php","sed -i \"s/'password_here'/'",{"Ref":"DBPassword"},"'/g\" wp-config.php"]]},"group":"root","mode":"000500","owner":"root"},"/tmp/setup.mysql":{"content":{"Fn::Join":["",["CREATE DATABASE ",{"Ref":"DBName"},";\n","CREATE USER '",{"Ref":"DBUser"},"'@'localhost' IDENTIFIED BY '",{"Ref":"DBPassword"},"';\n","GRANT ALL ON ",{"Ref":"DBName"},".* TO '",{"Ref":"DBUser"},"'@'localhost';\n","FLUSH PRIVILEGES;"]]},"group":"root","mode":"000400","owner":"root"}},"packages":{"yum":{"httpd":[],"mysql":[],"mysql-devel":[],"mysql-libs":[],"mysql-server":[],"php":[],"php-mysql":[]}},"services":{"sysvinit":{"httpd":{"enabled":"true","ensureRunning":"true"},"mysqld":{"enabled":"true","ensureRunning":"true"}}},"sources":{"/var/www/html":"http://wordpress.org/latest.tar.gz"}}}},"Properties":{"ImageId":{"Fn::FindInMap":["AWSRegionArch2AMI",{"Ref":"AWS::Region"},{"Fn::FindInMap":["AWSInstanceType2Arch",{"Ref":"InstanceType"},"Arch"]}]},"InstanceType":{"Ref":"InstanceType"},"KeyName":{"Ref":"KeyName"},"SecurityGroups":[{"Ref":"WebServerSecurityGroup"}],"UserData":{"Fn::Base64":{"Fn::Join":["",["#!/bin/bash -xe\n","yum update -y aws-cfn-bootstrap","/opt/aws/bin/cfn-init -v ","         --stack ",{"Ref":"AWS::StackName"},"         --resource WebServer ","         --configsets wordpress_install ","         --region ",{"Ref":"AWS::Region"},"\n","/opt/aws/bin/cfn-signal -e $? ","         --stack ",{"Ref":"AWS::StackName"},"         --resource WebServer ","         --region ",{"Ref":"AWS::Region"},"\n"]]}}},"Type":"AWS::EC2::Instance"},"WebServerSecurityGroup":{"Properties":{"GroupDescription":"Enable HTTP access via port 80 locked down to the load balancer + SSH access","SecurityGroupIngress":[{"CidrIp":"0.0.0.0/0","FromPort":"80","IpProtocol":"tcp","ToPort":"80"},{"CidrIp":{"Ref":"SSHLocation"},"FromPort":"22","IpProtocol":"tcp","ToPort":"22"}]},"Type":"AWS::EC2::SecurityGroup"}}}
